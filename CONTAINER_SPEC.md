## コンテナ仕様

この文書は、Excel の繰り返し領域（コンテナ）の最小限かつ実用的な仕様だけを記載します。詳細な使い方やCLIオプションは README を参照してください。

- 設定ファイルは YAML で記述してください（以下の例も YAML）。
- コンテナキーは必ず `json.` で始め、配列は 1 始まりの数値インデックスを用います（例: `json.orders.1.items.1`）。
- 範囲は Excel 側の「名前の定義」で指定します。コンテナ定義に `range` キーは持ちません。

### 1) 範囲の指定方法（Excel 側）

各コンテナの“ベース名”に対応する Excel の定義名を作成します。

- ルート例: `json.orders.1` のベースは `orders` → Excel 定義名は `orders`
- 子例: `json.orders.1.items.1` のベースは `orders.items` → Excel 定義名は `orders.items`

定義名はシート名付きの A1 参照を指すようにしてください（例: `Sheet1!$B$2:$D$10`）。

### 2) コンテナ定義（YAML）

コンテナ定義は最小限です。範囲は Excel 側の定義名から解決されるため、ここでは指定しません。

```yaml
containers:
  # 親（範囲上限の宣言用）。increment を 0（既定）にしておくと扱いやすい
  json.orders: {}

  # 行方向に1行ずつ繰り返し
  json.orders.1:
    direction: row
    increment: 1

  # 子（同様に Excel 側で orders.items を定義しておく）
  json.orders.1.items.1:
    direction: row
    increment: 2

  # さらに孫
  json.orders.1.items.1.details.1:
    direction: row
    increment: 1
    labels: ["sku"]        # 任意：この行/列（下位階層セルは除外）に含まれる限り継続
  # 要素数の共通上限は CLI の --max-elements で指定します
```

パラメータの意味:

- direction: `row` または `column`。省略時は `row`。
- increment: 0 以上の整数。0 は「繰り返しなし（1件のみ）」を意味します。
- labels: 文字列の配列（任意）。ラベル文字列が各インスタンスの行/列内に見つかる限り継続します。下位階層の `json.*` セルは判定から除外します。
備考: 要素数の共通上限は CLI の `--max-elements` で指定します。

### 3) 動作の要点

- 範囲解決: コンテナのベースに対応する Excel の定義名から A1 範囲を解決します。
- 項目抽出: 解決した範囲内の `json.*` セル名から、当該コンテナ「直下」の項目だけを自動抽出します（より深い階層は除外）。
- 要素数: 既存の命名済みインデックス、実セル値、ラベル、範囲境界をもとにカウント。共通上限は `--max-elements` でクリップされます。`increment=0` は常に 1 件。
- 生成: 第1要素の相対位置から 2 以降を計算し、`json....{index}.{field}` を動的生成します。
- 階層: 子要素は直近の親の範囲を超えません。

### 4) Excel 側の定義名 例

| コンテナ | ベース | Excel 定義名 | 例（参照） |
|---|---|---|---|
| json.orders.1 | orders | orders | Sheet1!$B$2:$D$10 |
| json.orders.1.items.1 | orders.items | orders.items | Sheet1!$B$12:$D$20 |
| json.orders.1.items.1.details.1 | orders.items.details | orders.items.details | Sheet1!$B$22:$C$22 |

### 5) 参考

- CLI オプション、変換ルール（--transform）、スキーマ連携、出力整形などの総合的な使い方は README を参照してください。
- 罫線解析による矩形検出の考え方は README の該当節を参照してください（任意機能）。

本仕様は重複説明を避けるため、必要最小限の記述に留めています。詳細は README を参照してください。


## 実装メモ（安定性・性能のための要点）

以下は動作の安定性とパフォーマンスのために設けている内部仕様の要点です。利用者が設定や挙動を理解する助けになります。

- 罫線矩形の検出とアンカー優先
  - 罫線はセルの「外周の辺」に限り判定し、対角線や接点だけの接続は矩形とみなしません（辺接続のみ）。
  - 定義名（Excelの「名前」）のアンカー位置を起点としたスキャンを優先し、矩形を安定に検出します。
  - 同一矩形の重複検出は除去し、座標による安定ソートで順序を固定化します。

- 配列の .1 セマンティクスと優先順位
  - 配列インデックスは 1 始まり（例: `json.items.1`）。先頭要素（`.1`）は「ソース自身の明示定義」を尊重します。
  - distribute_internal_slice による配列分配時、先頭要素（j==0）は生成名や別定義の存在によってスキップしません。
  - 2 要素目以降（j>0）は、当該インデックスに「生成名」または「明示的な定義名」がある場合はそちらを優先し、暗黙生成はスキップします。
  - 配列要素の既存フィールドが非空の場合は上書きしません（安全なマージ）。

- キャッシュ戦略
  - 罫線有無の判定はメモ化して高速化しています（キーにはワークシートタイトルを含め、シート間の衝突を防止）。
  - 罫線の完全性を再計算する場面など、レイアウト依存の評価直前にはキャッシュをクリアして整合性を担保します。

- 例外処理ポリシー
  - 過剰な try/except は廃止し、異常時はスタックトレースが上がる方針です（デバッグ容易性を優先）。
  - 低レベル関数では境界チェックや入力検証などの明示的ガードで正常系・異常系を分離しています。

- 名前解決の基本方針
  - 入力は原則として Excel の定義名（名前の定義）ベースのみを対象とします（defined-names-only）。
  - `json.` で始まるセル名のみが出力に寄与し、出力 JSON 内に `json` というキーは含めません。

